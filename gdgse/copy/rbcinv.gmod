% Parameters
parameters beta sigma alpha delta phi Iss;
beta  = 0.98;		% discount factor
sigma = 2.0;		% CRRA coefficient
alpha = 0.36;		% capital share
delta = 0.025;		% depreciation rate
phi   = 0.975;      % Investment irreversibility

% Exogenous States
var_shock z;
shock_num = 9;
z = [-0.009000000000000001, -0.006750000000000001, -0.0045000000000000005, -0.0022500000000000003, 0.0, 0.0022500000000000003, 0.0045000000000000005, 0.006750000000000001, 0.009000000000000001];
shock_trans = [0.2997915954686959 0.0 0.0 0.0 0.0 0.0 0.0 0.0 3.518962806592363e-5; 0.1468590563758959 0.23522952143515136 0.29155620190103265 0.21128555006621186 0.08948161070006966 0.022121085718597944 0.0031866805262243947 0.00026694752780032083 0.0002802932768162236; 0.05762822227615314 0.14705757307109943 0.2654215605998526 0.28005476158111775 0.17275928191970524 0.062263542359461965 0.013092777076742279 0.0016033564085408125 0.0017222811158675855; 0.017864420562816546 0.07064357087458546 0.18574512631267154 0.28536457462016895 0.25632218228299797 0.13458865731311143 0.04127393210905195 0.007381183611767539 0.008197535924596155; 0.004332448363012557 0.026063913402248794 0.09989815537154749 0.22353571619046736 0.29233953334544754 0.22353571619046742 0.09989815537154745 0.026063913402248784 0.030396361765261393; 0.000816352312828562 0.007381183611767554 0.04127393210905196 0.1345886573131114 0.256322182282998 0.28536457462016895 0.18574512631267148 0.0706435708745855 0.08850799143740207; 0.00011892470732676076 0.0016033564085408615 0.013092777076742284 0.062263542359461965 0.17275928191970513 0.2800547615811178 0.26542156059985267 0.14705757307109935 0.2046857953472525; 1.3345749015906309e-5 0.0002669475278002703 0.003186680526224491 0.022121085718597944 0.08948161070006966 0.2112855500662118 0.2915562019010327 0.2352295214351513 0.3820885778110472; 1.1505767815436636e-6 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.5890103628687295];

var_shock v;
shock_num = 9;
v = [-0.026000000000000002, -0.0245, -0.023000000000000003, -0.021500000000000002, -0.02, -0.018500000000000003, -0.017, -0.0155, -0.014];
shock_trans = [0.2997915954686959 0.0 0.0 0.0 0.0 0.0 0.0 0.0 3.518962806592363e-5; 0.1468590563758959 0.23522952143515136 0.29155620190103265 0.21128555006621186 0.08948161070006966 0.022121085718597944 0.0031866805262243947 0.00026694752780032083 0.0002802932768162236; 0.05762822227615314 0.14705757307109943 0.2654215605998526 0.28005476158111775 0.17275928191970524 0.062263542359461965 0.013092777076742279 0.0016033564085408125 0.0017222811158675855; 0.017864420562816546 0.07064357087458546 0.18574512631267154 0.28536457462016895 0.25632218228299797 0.13458865731311143 0.04127393210905195 0.007381183611767539 0.008197535924596155; 0.004332448363012557 0.026063913402248794 0.09989815537154749 0.22353571619046736 0.29233953334544754 0.22353571619046742 0.09989815537154745 0.026063913402248784 0.030396361765261393; 0.000816352312828562 0.007381183611767554 0.04127393210905196 0.1345886573131114 0.256322182282998 0.28536457462016895 0.18574512631267148 0.0706435708745855 0.08850799143740207; 0.00011892470732676076 0.0016033564085408615 0.013092777076742284 0.062263542359461965 0.17275928191970513 0.2800547615811178 0.26542156059985267 0.14705757307109935 0.2046857953472525; 1.3345749015906309e-5 0.0002669475278002703 0.003186680526224491 0.022121085718597944 0.08948161070006966 0.2112855500662118 0.2915562019010327 0.2352295214351513 0.3820885778110472; 1.1505767815436636e-6 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.5890103628687295];

% Endogenous States
var_state K;
Kss  = (alpha/(1/beta - 1 + delta))^(1/(1-alpha));
Iss = Kss*delta;
KPts = 101;
KMin = Kss*0.5;
KMax = Kss*1.5;
K    = linspace(KMin,KMax,KPts);

% Interp
var_interp c_interp mu_interp;
initial c_interp exp(z).*K.^alpha+(1-delta)*K;
initial mu_interp 0;
% Time iterations update
c_interp = c;
mu_interp = mu;

% Endogenous variables as unknowns of equations
var_policy c K_next mu;
inbound c       0 exp(z).*K.^alpha+(1-delta)*K;
inbound K_next  (1-delta)*K+phi*Iss exp(z).*K.^alpha+(1-delta)*K;
inbound mu      0 1.0;

% Other endogenous variables
var_aux w Inv;

model;
  % Budget constraints
  u_prime = c^(-sigma);
  kret_next' = exp(z')*alpha*K_next^(alpha-1) + 1-delta;
  
  % Evaluate the interpolation object to get future consumption
  c_future' = c_interp'(K_next);
  mu_future' = mu_interp'(K_next); 
  u_prime_future' = c_future'^(-sigma);
  
  % Calculate residual of the equation
  euler_residual = 1 - GDSGE_EXPECT{exp(v')*u_prime_future'*(kret_next'-(1-delta)*mu_future')}/(u_prime*(1-mu));
  market_clear = exp(z)*K^alpha + (1-delta)*K - c - K_next;
  
  % Calcualte other endogenous variables
  w = exp(z)*(1-alpha)*K^alpha;
  Inv = K_next - (1-delta)*K;
  
  equations;
    euler_residual;
    mu*(Inv - phi*Iss);
    market_clear;
  end;
end;

simulate;
  num_periods = 10000;
  num_samples = 100;
  initial K Kss;
  initial shock 1;
  var_simu c K w Inv;
  K' = K_next;
end;
