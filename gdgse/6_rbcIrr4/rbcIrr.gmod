% Parameters
parameters beta sigma alpha delta phi Iss;
beta  = 0.99;		% discount factor
sigma = 2.0;		% CRRA coefficient
alpha = 0.36;		% capital share
delta = 0.025;		% depreciation rate
phi   = 0.975;       % Investment irreversibility

% Exogenous States
var_shock z;
shock_num = 11;
z = [0.99314116, 0.99450915, 0.99587903, 0.9972508 , 0.99862445,
       1.        , 1.00137744, 1.00275678, 1.00413802, 1.00552116,
       1.00690621];
shock_trans = [[2.93618538e-01, 6.46809269e-01, 5.74864632e-02, 2.07288826e-03,
        1.28283263e-05, 1.29644437e-08, 2.07745431e-12, 7.84240963e-17,
        0.00000000e+00, 0.00000000e+00, 0.00000000e+00],
       [9.35826246e-02, 5.02827117e-01, 3.44677951e-01, 5.71698997e-02,
        1.73343430e-03, 8.96605098e-06, 7.54512615e-09, 1.00461469e-12,
        0.00000000e+00, 0.00000000e+00, 0.00000000e+00],
       [6.51107053e-03, 1.34524148e-01, 4.69970835e-01, 3.40026517e-01,
        4.77457169e-02, 1.21645232e-03, 5.25635771e-06, 3.68225388e-09,
        4.07335789e-13, 0.00000000e+00, 0.00000000e+00],
       [1.00800526e-04, 9.63985300e-03, 1.57980024e-01, 4.92491338e-01,
        3.03019919e-01, 3.59952222e-02, 7.70062927e-04, 2.77855268e-06,
        1.61994208e-09, 1.48865900e-13, 0.00000000e+00],
       [3.60824368e-07, 1.72531270e-04, 1.36463127e-02, 1.90612445e-01,
        5.04613733e-01, 2.63970554e-01, 2.65067805e-02, 4.75848483e-04,
        1.43311243e-06, 6.95196649e-10, 5.30686414e-14],
       [2.92844320e-10, 7.26001859e-07, 2.88805607e-04, 1.91841963e-02,
        2.26174834e-01, 5.08702876e-01, 2.26174834e-01, 1.91841963e-02,
        2.88805607e-04, 7.25708996e-07, 2.92844304e-10],
       [5.30523173e-14, 6.95250007e-10, 1.43311295e-06, 4.75848654e-04,
        2.65067901e-02, 2.63970649e-01, 5.04613915e-01, 1.90612514e-01,
        1.36463176e-02, 1.72170386e-04, 3.60824498e-07],
       [2.12456462e-18, 1.48864074e-13, 1.62010565e-09, 2.77883328e-06,
        7.70140694e-04, 3.59988573e-02, 3.03050520e-01, 4.92541073e-01,
        1.57995978e-01, 9.53983960e-03, 1.00810705e-04],
       [1.86907263e-23, 7.05285188e-18, 4.10013963e-13, 3.70660162e-09,
        5.29111371e-06, 1.22449572e-03, 4.80614204e-02, 3.42274835e-01,
        4.73078369e-01, 1.28801462e-01, 6.55412293e-03],
       [3.61236028e-29, 7.37650381e-23, 2.30793046e-17, 1.11331631e-12,
        8.36138527e-09, 9.93603090e-06, 1.92096351e-03, 6.33547469e-02,
        3.81966462e-01, 4.49041151e-01, 1.03706732e-01],
       [1.64810162e-35, 1.82741883e-28, 3.09268251e-22, 8.02359924e-17,
        3.21193938e-12, 2.00436888e-08, 1.98332443e-05, 3.20479059e-03,
        8.88769936e-02, 4.53949181e-01, 4.53949181e-01]];

var_shock z2;
shock_num = 11;
z = [0.97649204, 0.9778371 , 0.97918401, 0.98053278, 0.98188341,
       0.9832359 , 0.98459025, 0.98594646, 0.98730455, 0.9886645 ,
       0.99002633];
shock_trans = [[2.93618538e-01, 6.46809269e-01, 5.74864632e-02, 2.07288826e-03,
        1.28283263e-05, 1.29644437e-08, 2.07745431e-12, 7.84240963e-17,
        0.00000000e+00, 0.00000000e+00, 0.00000000e+00],
       [9.35826246e-02, 5.02827117e-01, 3.44677951e-01, 5.71698997e-02,
        1.73343430e-03, 8.96605098e-06, 7.54512615e-09, 1.00461469e-12,
        0.00000000e+00, 0.00000000e+00, 0.00000000e+00],
       [6.51107053e-03, 1.34524148e-01, 4.69970835e-01, 3.40026517e-01,
        4.77457169e-02, 1.21645232e-03, 5.25635771e-06, 3.68225388e-09,
        4.07335789e-13, 0.00000000e+00, 0.00000000e+00],
       [1.00800526e-04, 9.63985300e-03, 1.57980024e-01, 4.92491338e-01,
        3.03019919e-01, 3.59952222e-02, 7.70062927e-04, 2.77855268e-06,
        1.61994208e-09, 1.48865900e-13, 0.00000000e+00],
       [3.60824368e-07, 1.72531270e-04, 1.36463127e-02, 1.90612445e-01,
        5.04613733e-01, 2.63970554e-01, 2.65067805e-02, 4.75848483e-04,
        1.43311243e-06, 6.95196649e-10, 5.30686414e-14],
       [2.92844320e-10, 7.26001859e-07, 2.88805607e-04, 1.91841963e-02,
        2.26174834e-01, 5.08702876e-01, 2.26174834e-01, 1.91841963e-02,
        2.88805607e-04, 7.25708996e-07, 2.92844304e-10],
       [5.30523173e-14, 6.95250007e-10, 1.43311295e-06, 4.75848654e-04,
        2.65067901e-02, 2.63970649e-01, 5.04613915e-01, 1.90612514e-01,
        1.36463176e-02, 1.72170386e-04, 3.60824498e-07],
       [2.12456462e-18, 1.48864074e-13, 1.62010565e-09, 2.77883328e-06,
        7.70140694e-04, 3.59988573e-02, 3.03050520e-01, 4.92541073e-01,
        1.57995978e-01, 9.53983960e-03, 1.00810705e-04],
       [1.86907263e-23, 7.05285188e-18, 4.10013963e-13, 3.70660162e-09,
        5.29111371e-06, 1.22449572e-03, 4.80614204e-02, 3.42274835e-01,
        4.73078369e-01, 1.28801462e-01, 6.55412293e-03],
       [3.61236028e-29, 7.37650381e-23, 2.30793046e-17, 1.11331631e-12,
        8.36138527e-09, 9.93603090e-06, 1.92096351e-03, 6.33547469e-02,
        3.81966462e-01, 4.49041151e-01, 1.03706732e-01],
       [1.64810162e-35, 1.82741883e-28, 3.09268251e-22, 8.02359924e-17,
        3.21193938e-12, 2.00436888e-08, 1.98332443e-05, 3.20479059e-03,
        8.88769936e-02, 4.53949181e-01, 4.53949181e-01]];

% Endogenous States
var_state K;
Kss  = (alpha/(1/beta - 1 + delta))^(1/(1-alpha));
Iss = Kss*delta;
KPts = 101;
KMin = Kss*0.5;
KMax = Kss*1.5;
K    = linspace(KMin,KMax,KPts);

% Interp
var_interp c_interp mu_interp;
initial c_interp z.*K.^alpha+(1-delta)*K;
initial mu_interp 0;
% Time iterations update
c_interp = c;
mu_interp = mu;

% Endogenous variables as unknowns of equations
var_policy c K_next mu;
inbound c       0 z.*K.^alpha+(1-delta)*K;
inbound K_next  (1-delta)*K+phi*Iss z.*K.^alpha+(1-delta)*K;
inbound mu      0 1.0;

% Other endogenous variables
var_aux w Inv;

model;
  % Budget constraints
  u_prime = c^(-sigma);
  kret_next' = z'*alpha*K_next^(alpha-1) + 1-delta;
  
  % Evaluate the interpolation object to get future consumption
  c_future' = c_interp'(K_next);
  mu_future' = mu_interp'(K_next); 
  u_prime_future' = c_future'^(-sigma);
  
  % Calculate residual of the equation
  euler_residual = 1 - GDSGE_EXPECT{z2*u_prime_future'*(kret_next'-(1-delta)*mu_future')}/(u_prime*(1-mu));
  market_clear = z*K^alpha + (1-delta)*K - c - K_next;
  
  % Calcualte other endogenous variables
  w = z*(1-alpha)*K^alpha;
  Inv = K_next - (1-delta)*K;
  
  equations;
    euler_residual;
    mu*(Inv - phi*Iss);
    market_clear;
  end;
end;

simulate;
  num_periods = 10000;
  num_samples = 100;
  initial K Kss;
  initial shock 1;
  var_simu c K w Inv;
  K' = K_next;
end;
